<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Dosis:200">
<link rel="stylesheet" href="https:///maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
<style>

body{
  background-color: #bac5d1;
  padding: 0 10px;
  font-family: 'Open Sans', sans-serif;
}
tr {
    cursor: pointer;
}
.accordion-container{
  position: relative;
  max-width: 500px;
  height: auto;
  margin: 10px auto;
}
.accordion-container > h2{
  text-align: center;
  color: #fff;
  padding-bottom: 5px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #ddd;
}
.set{
  position: relative;
  width: 100%;
  height: auto;
  background-color: #f5f5f5;
}
.set > a{
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  color: #555;
  font-size: 30px;
  text-shadow: 2px 2px 4px #fff;
  font-weight: 600;
  border-bottom: 1px solid #ddd;
  -webkit-transition:all 0.2s linear;
  -moz-transition:all 0.2s linear;
  transition:all 0.2s linear;
}
.set > a.active {
    text-shadow: 1px 1px 2px #444;
}
.set > a i{
  float: right;
  margin-top: 2px;
}
.set > a.active{
  background-color:#3399cc;
  color: #fff;
}
.content{
  background-color: #fff;
  border-bottom: 1px solid #ddd;
  display:none;
}
.content p{
  padding: 10px 15px;
  margin: 0;
  color: #333;
}
tr.showMore td {
    background: yellow !important;
}

.container {
    margin: 0 auto;
    height: 250px;
    text-align: center;
}
.container ul {
    margin: 0;
    padding: 0;
}

.container li {
    background: linear-gradient(to bottom, #13baaf, #13baaf) no-repeat 0 0;
    transform: rotate(180deg);
    background-size: 4px 0%;
    transition: 2s;
    margin: 10px;
    width: 10px;
    height: 66px;
    display: inline-block;
    border-radius: 100px;
}

.animate-me{
  animation: one 3s .5s ease infinite;
  border-radius: 50px;
  
}
.container li:first-child{height: 33px;}
.container li:first-child .animate-me{
  background: linear-gradient(to bottom, #36b874, #36b874) no-repeat;
  animation-delay: .25s;
}

.container li:nth-child(2) .animate-me {
  background: linear-gradient(to bottom, #13baaf, #13baaf) no-repeat 0 0;
}

.container li:last-child{height: 99px;}
.container li:last-child .animate-me{
  background: linear-gradient(to bottom, #014260, #014260) no-repeat;
  animation-delay: .75s;
}

.container p {
    animation: blinker 1.5s linear infinite;
    font-size: 50px;
    margin: 25px 0;
}
.comparison {
    box-sizing: border-box;
    min-height: 20px;
}
.comparison div.side {
    display: inline-block; 
    width: 50%; 
    padding: 10px;
    background: #eeeeee;
}
.comparison .one-half h4 {
    -webkit-border-top-left-radius: 10px;
    -webkit-border-top-right-radius: 10px;
    -moz-border-radius-topleft: 10px;
    -moz-border-radius-topright: 10px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    background: #3799CC;
    border: 1px solid #ccc;
    padding: 10px;
    margin: 0 2px;
    color: #fff;
    font-size: 24px;
    text-shadow: 1px 1px 2px #000;
}

.comparison .one-half p.details {
    background: #eeeeee;
    padding: 10px;
    margin: 0 2px;
}
@media (min-width: 550px) {
    .column, .columns {
        margin-left: 0;
    }
    .one-half.column {
        width: 50%;
    }
}
@keyframes blinker {  
  50% { opacity: 0.0; }
}

@-webkit-keyframes one {
    100%, 0% {height: 10px;}
    80% {height: 100%;}
} 

p.resultData div {
    display: inline-block;
    margin: 0 5px 5px;;
    cursor: pointer;
    padding: 8px;
    border: 1px solid #dddddd;
    background: #fefefe;
}
.compareTrial h2 {
    font-family: 'Dosis', sans-serif;
}
.selectDate {
    background: yellow !important;
}
.buttons {
    padding: 0 20px;
}
#comparisonTable {
    box-sizing: border-box;
}
#comparisonTable tr td:nth-child(1) span,
#comparisonTable tr th:nth-child(1) span {
    margin-left: 10px;
}
#comparisonTable > tbody > tr > td:nth-child(2) {
    color: #751313;
}
#comparisonTable > tbody > tr > td:nth-child(3) {
    color: #187513;
}
</style>

<div class="set">
        <a href="#" class="active">
          Trial List 
          <i class="fa fa-minus"></i>
        </a>
        <div class="content" style="display:block;padding: 20px;">
                <table id="example" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th><span>Title</span></th>
                                <th>NCT</th>
                                <th>First Submitted</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
        </div>
      </div>
      <div class="set">
        <a href="#" class="compare">
          Compare 
          <i class="fa fa-plus"></i>
        </a>
        <div class="content">
          <p class="compareTrial"> Please select a trial above.</p>
          <div class="buttons">
              <button class="viewOne" style="display:none;">View Single Record <span></span></button>
              <button class="compareTwo" style="display:none;">Compare Two Records <span></span></button>
          </div>
          <div class="comparison">
                <table id="comparisonTable" class="display" style="width:100%; display:none; overflow: wrap;">
                        <thead>
                            <tr>
                                <th><span>Attribute</span></th>
                                <th class="dateOne"></th>
                                <th class="dateTwo"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
          </div>
        </div>
      </div>
      
      


<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
<script>
$.getJSON('/unique', function(data) {
    
    console.log(data)
    data.forEach(trial => {
        $('#example tbody').append(`
            <tr id="${trial.nct}">
                <td class="title">${trial.BriefTitle}</td>
                <td class="nct">${trial.nct}</td>
                <td class="FirstSubmitted">${trial.FirstSubmitted}</td>
            </tr>`)
    })

    $(document).ready(function() {
        $('#example').DataTable({
            "pageLength": 5,
            "lengthMenu": [ 5, 10, 25, 50, 75, 100 ]
        });
    } );

    $('#example tbody tr').click(function() {
        $('#example tbody tr').removeClass('showMore');
        $(this).toggleClass('showMore');
        var title = $(this).children('td.title').text().trim();
        $('a.compare').click();
        $('p.compareTrial').html(`<h2>${title}</h2>
        
        <p class="resultData"></p>
        `)
        // <div class="container">
        // <ul>
        //     <li><div class="animate-me"></div></li>
        //     <li><div class="animate-me"></div></li>
        //     <li><div class="animate-me"></div></li>
        // </ul>
        // <div class="text">
        //     <p style="text-align:center">loading...</p>
        // </div>
        // </div>
        var nct = $(this).attr('id');
        console.log('nct', nct);
        $.getJSON('/nct/'+nct, function(nctData) {
            console.log(nctData);
            // $('.container').fadeOut()
            $('p.resultData').html(`${nctData.length} total versions<br/>`)
            nctData.forEach(version => {
                console.log(version.date)
                $('p.resultData').append(`<div>${version.date}</div>`)
            })

            $('p.resultData div').click(function() {
                $(this).toggleClass('selectDate');
                if ($('.resultData .selectDate').length === 1) {
                    $('button.viewOne').show();
                    $('button.compareTwo').hide();
                } else if ($('.resultData .selectDate').length === 2) {
                    $('button.viewOne').hide();
                    $('button.compareTwo').show();
                } else{
                    $('button.viewOne').hide();
                    $('button.compareTwo').hide();
                }
            })

            $('button.compareTwo').click(function() {
                var date1 = $('.selectDate:first').text().trim();
                var date2 = $('.selectDate:last').text().trim();
                console.log(date1, date2);
                $('#comparisonTable').show()
                $('#comparisonTable th.dateOne').text(date1);
                $('#comparisonTable th.dateTwo').text(date2);
                
                // $('.comparison').html(`
                // <div class="row">
                //     <div class="one-half column one">
                //             <h4>${date1}</h4>
                //             <p class="details">
                //                 </p>
                //     </div>
                //     <div class="one-half column two">
                //             <h4>${date2}</h4>
                //             <p class="details">
                            
                //             </p>
                //     </div>
                // </div>
                // `)
                
                oneIndex = (nctData).findIndex((obj => obj.date == date1));
                twoIndex = (nctData).findIndex((obj => obj.date == date2));
                console.log(oneIndex, twoIndex);
                
                var a = (nctData)[oneIndex];
                var b = (nctData)[twoIndex]
                var diffs = difference(a,b);

                for (var key in diffs){
                    console.log(key);
                    //if (JSON.stringify(key) != '_id' || JSON.stringify(key) != 'date') {
                        //$('.one p.details').append(`<p><strong>${key}</strong>: <pre>${a[key]}</pre></p>`);
                        //$('.two p.details').append(`<p><strong>${key}</strong>: <pre>${b[key]}</pre></p>`)
                   // }
                   if (key.length <= 45) {
                   $('#comparisonTable tbody').append(`
                        <tr>
                            <td><span>${key}</span></td>
                            <td>${a[key]}</td>
                            <td>${b[key]}</td>
                        </tr>
                   `)
                }
                delete a[key]
                delete b[key]
            }
            console.log(a);
            $('.comparison').append('<h2 style="padding:0 20px;">Unchanged Values</h2>')
            for (var key in a){
                $('.comparison').append(`
                    <p><strong>${key}</strong>: ${a[key]}</p>
                `)
            }
            })
            
        }) //get one trial full history
    })
});




function difference(object, base) {
	function changes(object, base) {
		return _.transform(object, function(result, value, key) {
			if (!_.isEqual(value, base[key])) {
				result[key] = (_.isObject(value) && _.isObject(base[key])) ? changes(value, base[key]) : value;
			}
		});
	}
	return changes(object, base);
}

//Accordion 
$(document).ready(function() {
  $(".set > a").on("click", function() {
    if ($(this).hasClass("active")) {
      $(this).removeClass("active");
      $(this)
        .siblings(".content")
        .slideUp(200);
      $(".set > a i")
        .removeClass("fa-minus")
        .addClass("fa-plus");
    } else {
      $(".set > a i")
        .removeClass("fa-minus")
        .addClass("fa-plus");
      $(this)
        .find("i")
        .removeClass("fa-plus")
        .addClass("fa-minus");
      $(".set > a").removeClass("active");
      $(this).addClass("active");
      $(".content").slideUp(200);
      $(this)
        .siblings(".content")
        .slideDown(200);
    }
  });
});

</script>